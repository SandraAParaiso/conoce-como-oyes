<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conoce Cómo Oyes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #333;
            text-align: center;
        }
        .instructions {
            background-color: #f0f8ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #4682b4;
        }
        .reference-info {
            background-color: #e6ffe6;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #2e8b57;
        }
        .grid-container {
            overflow-x: auto;
            margin-bottom: 30px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            min-width: 800px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
        }
        .freq-header {
            background-color: #e6f2ff;
            font-weight: bold;
        }
        .reference-header {
            background-color: #e6ffe6;
            font-weight: bold;
        }
        .step-cell {
            font-weight: bold;
            background-color: #f9f9f9;
        }
        .db-cell {
            font-weight: bold;
            background-color: #f0f0f0;
        }
        .chart-container {
            height: 400px;
            margin-top: 30px;
            margin-bottom: 50px;
            position: relative;
            width: 100%;
        }
        .cell-clickable {
            cursor: pointer;
        }
        .cell-clickable:hover {
            background-color: #f0f0f0;
        }
        .cell-x {
            background-color: #b3d9ff;
            font-weight: bold;
        }
        .reference-x {
            background-color: #b3ffb3;
            font-weight: bold;
        }
        .results-table {
            width: 100%;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .btn-container {
            text-align: center;
            margin: 20px 0;
        }
        .btn {
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            color: white;
        }
        .btn-reset {
            background-color: #f44336;
        }
        .btn-export {
            background-color: #4CAF50;
        }
        .btn-calculate {
            background-color: #2196F3;
        }
        footer {
            margin-top: 40px;
            text-align: center;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Conoce Cómo Oyes</h1>
        
        <div class="instructions">
            <p>Marca con una "X" el último paso que hayas escuchado en cada presentación (haz clic en la celda correspondiente).</p>
            <p><strong>Importante:</strong> El tono de 4000 Hz se utiliza como referencia para las estimaciones. Asegúrate de marcar este tono primero.</p>
        </div>
        
        <div class="reference-info" id="reference-info">
            <p>Aún no has seleccionado el nivel de referencia. Por favor, marca primero dónde escuchas el tono de 4000 Hz.</p>
        </div>
        
        <div class="grid-container">
            <table id="audibility-table">
                <thead>
                    <tr id="header-row">
                        <th>Step</th>
                        <!-- Las cabeceras de frecuencia se insertan dinámicamente -->
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Las filas se insertan dinámicamente -->
                </tbody>
            </table>
        </div>
        
        <div class="btn-container">
            <button class="btn btn-calculate" id="calculate-btn" onclick="calculateResults()" disabled>Calcular Resultados</button>
            <button class="btn btn-reset" onclick="resetTable()">Reiniciar Tabla</button>
            <button class="btn btn-export" id="export-btn" onclick="exportToCSV()" disabled>Exportar Datos</button>
        </div>
        
        <div class="chart-container">
            <canvas id="audiogram-chart"></canvas>
        </div>
        
        <div class="chart-container">
            <canvas id="audibility-chart"></canvas>
        </div>
        
        <div class="results-container">
            <h2>Resultados</h2>
            <table class="results-table" id="results-table">
                <thead>
                    <tr>
                        <th>Frecuencia (Hz)</th>
                        <th>Umbral de Audibilidad (dB)</th>
                        <th>Diferencia (HL)</th>
                    </tr>
                </thead>
                <tbody id="results-body">
                    <!-- Los resultados se insertan dinámicamente -->
                </tbody>
            </table>
        </div>
        
        <footer>
            <p>&copy; 2025 Conoce Cómo Oyes - GitHub Version</p>
            <p>Basado en el trabajo de Serrano-Pedraza, I. (2023)</p>
        </footer>
    </div>
    
    <script>
        // Ejecutar inicialización cuando el DOM esté completamente cargado
        document.addEventListener('DOMContentLoaded', function() {
            initializeTable();
            initializeCharts();
        });
        
        // Definición de frecuencias (Hz)
        const frequencies = [125, 250, 500, 1000, 2000, 4000, 8000, 12000];
        
        // Configuración de pasos y decibelios
        const stepsAndDB = [
            {step: 1, dB: 55},
            {step: 2, dB: 50},
            {step: 3, dB: 45},
            {step: 4, dB: 40},
            {step: 5, dB: 35},
            {step: 6, dB: 30},
            {step: 7, dB: 25},
            {step: 8, dB: 20},
            {step: 9, dB: 15},
            {step: 10, dB: 10},
            {step: 11, dB: 5},
            {step: 12, dB: 0},
            {step: 13, dB: -5},
            {step: 14, dB: -10},
            {step: 15, dB: -15},
            {step: 16, dB: -20}
        ];
        
        // Valores de referencia estándar (ISO 1961, Robinson y Dadson, 1956)
        const standardThresholds = [21.4, 11.2, 6, 4.2, 1, -3.9, 15.3, 12];
        
        // Variables globales
        let referenceStep = null; // Paso de referencia (4000 Hz)
        let audiogramChart = null;
        let audibilityChart = null;
        let marks = {}; // Para almacenar las posiciones de X por columna
        let results = {}; // Para almacenar los resultados calculados
        
        // La inicialización se realiza ahora en la parte superior del script
        
        // Inicializar la tabla
        function initializeTable() {
            // Agregar cabeceras de frecuencia
            const headerRow = document.getElementById('header-row');
            // Eliminar la columna de dB
            headerRow.removeChild(headerRow.firstChild);
            
            frequencies.forEach(freq => {
                const th = document.createElement('th');
                th.classList.add(freq === 4000 ? 'reference-header' : 'freq-header');
                th.textContent = `${freq} Hz`;
                headerRow.appendChild(th);
            });
            
            // Crear filas de la tabla
            const tableBody = document.getElementById('table-body');
            stepsAndDB.forEach(item => {
                const row = document.createElement('tr');
                
                // Celda de paso (no mostramos los dB)
                const stepCell = document.createElement('td');
                stepCell.classList.add('step-cell');
                stepCell.textContent = item.step;
                row.appendChild(stepCell);
                
                // Celdas para cada frecuencia
                frequencies.forEach(freq => {
                    const cell = document.createElement('td');
                    cell.classList.add('cell-clickable');
                    cell.dataset.step = item.step;
                    cell.dataset.freq = freq;
                    cell.dataset.db = item.dB;
                    
                    // Agregar evento de clic
                    cell.addEventListener('click', function() {
                        handleCellClick(this);
                    });
                    
                    row.appendChild(cell);
                });
                
                tableBody.appendChild(row);
            });
        }
        
        // Manejar el clic en una celda
        function handleCellClick(cell) {
            const freq = parseInt(cell.dataset.freq);
            const step = parseInt(cell.dataset.step);
            
            // Si ya hay una X en esta columna, quitarla
            if (marks[freq]) {
                const oldCell = document.querySelector(`td[data-freq="${freq}"][data-step="${marks[freq]}"]`);
                if (oldCell) {
                    oldCell.textContent = '';
                    oldCell.classList.remove('cell-x', 'reference-x');
                }
            }
            
            // Poner X en la celda actual
            cell.textContent = 'X';
            
            // Si es 4000 Hz, marcar como referencia
            if (freq === 4000) {
                cell.classList.add('reference-x');
                referenceStep = step;
                updateReferenceInfo();
            } else {
                cell.classList.add('cell-x');
            }
            
            marks[freq] = step;
            
            // Activar botones si tenemos la referencia (4000 Hz) marcada
            if (marks[4000]) {
                document.getElementById('calculate-btn').disabled = false;
                if (Object.keys(marks).length > 1) {
                    document.getElementById('export-btn').disabled = false;
                }
            }
        }
        
        // Actualizar información de referencia
        function updateReferenceInfo() {
            const infoDiv = document.getElementById('reference-info');
            
                            if (referenceStep !== null) {
                infoDiv.innerHTML = `
                    <p><strong>Nivel de referencia establecido:</strong> Paso ${referenceStep} en 4000 Hz.</p>
                    <p>Este nivel será considerado como 0 dB para los cálculos. Los pasos anteriores tendrán valores positivos y los posteriores valores negativos, variando de 5 en 5 dB.</p>
                `;
            } else {
                infoDiv.innerHTML = `
                    <p>Aún no has seleccionado el nivel de referencia. Por favor, marca primero dónde escuchas el tono de 4000 Hz.</p>
                `;
            }
        }
        
        // Calcular y mostrar resultados
        function calculateResults() {
            if (!marks[4000]) {
                alert('Debes marcar primero el tono de referencia (4000 Hz).');
                return;
            }
            
            const resultsBody = document.getElementById('results-body');
            resultsBody.innerHTML = '';
            
            const audibilityData = [];
            const audiogramData = [];
            results = {};
            
            // Para cada frecuencia
            frequencies.forEach((freq, index) => {
                if (marks[freq]) {
                    // Obtener el paso marcado con X
                    const step = marks[freq];
                    
                    // Calcular dB en relación al paso de referencia (4000 Hz)
                    // Si es el paso de referencia, será 0 dB
                    // Para pasos anteriores, sumar 5 dB por cada paso (más audibles)
                    // Para pasos posteriores, restar 5 dB por cada paso (menos audibles)
                    const calculatedDB = (referenceStep - step) * 5;
                    
                    // Calcular la diferencia con el umbral estándar (audiograma)
                    const difference = (standardThresholds[index] - calculatedDB).toFixed(1);
                    
                    // Guardar resultados
                    results[freq] = {
                        step: step,
                        dB: calculatedDB,
                        difference: difference
                    };
                    
                    // Crear fila para la tabla de resultados
                    const row = document.createElement('tr');
                    
                    const freqCell = document.createElement('td');
                    freqCell.textContent = freq;
                    
                    const thresholdCell = document.createElement('td');
                    thresholdCell.textContent = calculatedDB.toFixed(1);
                    
                    const diffCell = document.createElement('td');
                    diffCell.textContent = difference;
                    
                    row.appendChild(freqCell);
                    row.appendChild(thresholdCell);
                    row.appendChild(diffCell);
                    
                    resultsBody.appendChild(row);
                    
                    // Datos para los gráficos
                    audibilityData.push({
                        x: freq,
                        y: calculatedDB
                    });
                    
                    audiogramData.push({
                        x: freq,
                        y: parseFloat(difference)
                    });
                }
            });
            
            // Actualizar gráficos
            updateCharts(audibilityData, audiogramData);
        }
        
        // Asegurarnos que los gráficos están visibles y son del tamaño adecuado
        window.onload = function() {
            // Re-renderizar los gráficos después de que todo esté cargado
            if (audiogramChart && audibilityChart) {
                audiogramChart.resize();
                audibilityChart.resize();
            }
        };
        
        // Inicializar los gráficos
        function initializeCharts() {
            // Gráfico de curva de audibilidad
            const ctxAudibility = document.getElementById('audibility-chart').getContext('2d');
            audibilityChart = new Chart(ctxAudibility, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Tu umbral de audibilidad',
                            data: [],
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            tension: 0.4,
                            pointRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'logarithmic',
                            title: {
                                display: true,
                                text: 'Frecuencia (Hz)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value;
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Nivel de Presión Sonora (dB)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            min: -25,
                            max: 60
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Curva de Audibilidad Mínima',
                            font: {
                                size: 18
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y} dB`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Gráfico de audiograma
            const ctxAudiogram = document.getElementById('audiogram-chart').getContext('2d');
            audiogramChart = new Chart(ctxAudiogram, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Tu audiograma',
                            data: [],
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            tension: 0.4,
                            pointRadius: 6
                        },
                        {
                            label: 'Referencia normal',
                            data: frequencies.map(f => ({
                                x: f,
                                y: 0
                            })),
                            borderColor: 'rgba(0, 0, 0, 0.5)',
                            backgroundColor: 'rgba(0, 0, 0, 0)',
                            borderDash: [5, 5],
                            tension: 0,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'logarithmic',
                            title: {
                                display: true,
                                text: 'Frecuencia (Hz)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value;
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Hearing Level (dB re ISO 1961)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            reverse: true, // Valores más bajos son mejor audición
                            min: -30,
                            max: 80
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Audiograma',
                            font: {
                                size: 18
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y} dB`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Actualizar los gráficos con los nuevos datos
        function updateCharts(audibilityData, audiogramData) {
            // Ordenar los datos por frecuencia
            audibilityData.sort((a, b) => a.x - b.x);
            audiogramData.sort((a, b) => a.x - b.x);
            
            // Actualizar los conjuntos de datos
            audibilityChart.data.datasets[0].data = audibilityData;
            audiogramChart.data.datasets[0].data = audiogramData;
            
            // Actualizar los gráficos
            audibilityChart.update();
            audiogramChart.update();
        }
        
        // Reiniciar la tabla y los resultados
        function resetTable() {
            // Quitar todas las X
            document.querySelectorAll('.cell-x, .reference-x').forEach(cell => {
                cell.textContent = '';
                cell.classList.remove('cell-x', 'reference-x');
            });
            
            // Limpiar las marcas y resultados
            marks = {};
            results = {};
            referenceStep = null;
            
            // Actualizar información de referencia
            updateReferenceInfo();
            
            // Limpiar la tabla de resultados
            document.getElementById('results-body').innerHTML = '';
            
            // Desactivar botones
            document.getElementById('calculate-btn').disabled = true;
            document.getElementById('export-btn').disabled = true;
            
            // Reiniciar los gráficos
            audibilityChart.data.datasets[0].data = [];
            audiogramChart.data.datasets[0].data = [];
            audibilityChart.update();
            audiogramChart.update();
        }
        
        // Exportar los resultados a CSV
        function exportToCSV() {
            if (Object.keys(results).length === 0) {
                alert('No hay resultados para exportar. Primero debes calcular los resultados.');
                return;
            }
            
            let csvContent = "Frecuencia (Hz),Umbral de Audibilidad (dB),Diferencia (HL)\n";
            
            frequencies.forEach(freq => {
                if (results[freq]) {
                    csvContent += `${freq},${results[freq].dB.toFixed(1)},${results[freq].difference}\n`;
                }
            });
            
            // Crear un enlace para descargar el archivo
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'conoce_como_oyes_resultados.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
